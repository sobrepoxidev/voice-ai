; =====================================================
; oml_extensions_custom.conf - VERSI√ìN COMPLETA
; Con estados y AMD para DIDWW y Metrocom
; =====================================================

[from-pstn]
; Caso general: si viene un DID "normal" en EXTEN
exten => _X.,1,NoOp(üìû Llamada entrante DID: ${EXTEN} desde ${CALLERID(num)} peer=${CHANNEL(peername)})
 same => n,Goto(handle-inbound,${EXTEN},1)

; Cuando viene sin DID (extensi√≥n s)
exten => s,1,NoOp(üìû Llamada sin DID desde ${CALLERID(num)} peer=${CHANNEL(peername)})
 same => n,Set(PEER=${CHANNEL(peername)})
 same => n,NoOp(üåê Inbound peer: ${PEER})
 same => n,GotoIf($["${PEER}"="metrocom_out_aux"]?metrocom)
 same => n,GotoIf($["${PEER}"="metrocom_in_aux"]?metrocom)
 same => n,GotoIf($["${PEER}"="didww_in"]?didww)
 same => n,NoOp(‚ùì Peer desconocido, usando DID por defecto Metrocom)
 same => n,Goto(handle-inbound,50642052929,1)
 same => n(metrocom),Goto(handle-inbound,50642052929,1)
 same => n(didww),Goto(handle-inbound,18887719555,1)


[handle-inbound]
; ------------------ METROCOM (CR) ------------------
exten => 50642052929,1,NoOp(üìû Metrocom ‚Üí IA Retell | FROM=${CALLERID(num)})
 same => n,Set(FROM_NUM=${CALLERID(num)})
 same => n,Set(TO_NUM=50642052929)
 same => n,NoOp(üåê Registrando inbound en Retell: FROM=${FROM_NUM} TO=${TO_NUM})
 same => n,Set(RETELL_CALL_ID=${CURL(http://31.97.210.100:8500/api/retell/handle-inbound-get?from_number=${FROM_NUM}&to_number=${TO_NUM}&token=2ad554fb7f8cf11fb302721cdefdb9e2354e03bf8ec9d9c12ff1c1089d2cc5f6)})
 same => n,NoOp(ü§ñ Retell CALL_ID recibido: ${RETELL_CALL_ID})
 same => n,GotoIf($["${RETELL_CALL_ID}" = ""]?fallback-human-metrocom)
 same => n,Answer()
 same => n,Wait(1)
 same => n,Set(RETELL_URI=sip:${RETELL_CALL_ID}@sip.retellai.com)
 same => n,NoOp(üì° Marcando a ${RETELL_URI} via retell_out_udp)
 same => n,Dial(PJSIP/retell_out_udp/${RETELL_URI},60,T)
 same => n,Hangup()
 same => n(fallback-human-metrocom),NoOp(‚ö†Ô∏è Retell fall√≥, enviando a agentes 1002 y 1003)
 same => n,Answer()
 same => n,Dial(PJSIP/1002&PJSIP/1003,30,tT)
 same => n,Hangup()

; ------------------ DIDWW USA ------------------
exten => 18887719555,1,NoOp(üìû DIDWW ‚Üí IA Retell | FROM=${CALLERID(num)})
 same => n,Set(FROM_NUM=${CALLERID(num)})
 same => n,Set(TO_NUM=18887719555)
 same => n,NoOp(üåê Registrando inbound en Retell: FROM=${FROM_NUM} TO=${TO_NUM})
 same => n,Set(RETELL_CALL_ID=${CURL(http://31.97.210.100:8500/api/retell/handle-inbound-get?from_number=${FROM_NUM}&to_number=${TO_NUM}&token=2ad554fb7f8cf11fb302721cdefdb9e2354e03bf8ec9d9c12ff1c1089d2cc5f6)})
 same => n,NoOp(ü§ñ Retell CALL_ID recibido: ${RETELL_CALL_ID})
 same => n,GotoIf($["${RETELL_CALL_ID}" = ""]?fallback-human-didww)
 same => n,Answer()
 same => n,Wait(1)
 same => n,Set(RETELL_URI=sip:${RETELL_CALL_ID}@sip.retellai.com)
 same => n,NoOp(üì° Marcando a ${RETELL_URI} via retell_out_udp)
 same => n,Dial(PJSIP/retell_out_udp/${RETELL_URI},60,T)
 same => n,Hangup()
 same => n(fallback-human-didww),NoOp(‚ö†Ô∏è Retell fall√≥, enviando a agentes 1002 y 1003)
 same => n,Answer()
 same => n,Dial(PJSIP/1002&PJSIP/1003,30,tT)
 same => n,Hangup()


[from-agent]
exten => _1XXX,1,NoOp(üìû Llamada interna ${CALLERID(num)} ‚Üí ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN},30,tT)
 same => n,Hangup()
exten => _X.,1,NoOp(üåê Enrutando a normalizaci√≥n ‚Üí ${EXTEN})
 same => n,Goto(oml-outr,${EXTEN},1)
 same => n,Hangup()


[oml-outr]
include => oml-outr-2


[oml-outr-2]
exten => _+506XXXXXXXX,1,NoOp(üá®üá∑ E.164 CR: ${EXTEN})
 same => n,Set(NUM=${EXTEN:1})
 same => n,Goto(oml-router,${NUM},1)
exten => _+X.,1,NoOp(üåç E.164 Internacional: ${EXTEN})
 same => n,Goto(oml-router,${EXTEN},1)
exten => _506XXXXXXXX,1,NoOp(üá®üá∑ CR con 506: ${EXTEN})
 same => n,Goto(oml-router,${EXTEN},1)
exten => _XXXXXXXXXX,1,NoOp(üá∫üá∏ NANPA: ${EXTEN})
 same => n,Set(NUM=+1${EXTEN})
 same => n,Goto(oml-router,${NUM},1)
exten => _XXXXXXXX,1,NoOp(üá®üá∑ Local 8d: ${EXTEN})
 same => n,Set(NUM=506${EXTEN})
 same => n,Goto(oml-router,${NUM},1)
exten => _X.,1,NoOp(‚ùì Formato desconocido: ${EXTEN})
 same => n,Hangup()


[oml-router]
exten => _506XXXXXXXX,1,NoOp(üîç CR: ${EXTEN} | CAMPID=${OMLCAMPID})
 same => n,GotoIf($["${OMLCAMPID}" = "2"]?metrocom-cr:didww-cr)
 same => n(metrocom-cr),NoOp(üîÄ Campaign 2 ‚Üí Metrocom)
 same => n,Goto(metrocom-out,${EXTEN},1)
 same => n(didww-cr),NoOp(üîÄ Campaign 1 ‚Üí DIDWW)
 same => n,Set(NUM=+${EXTEN})
 same => n,Goto(didww-out,${NUM},1)

exten => _+506XXXXXXXX,1,NoOp(üîç +CR: ${EXTEN} | CAMPID=${OMLCAMPID})
 same => n,GotoIf($["${OMLCAMPID}" = "2"]?metrocom-cr:didww-cr)
 same => n(metrocom-cr),NoOp(üîÄ Campaign 2 ‚Üí Metrocom)
 same => n,Goto(metrocom-out,${EXTEN},1)
 same => n(didww-cr),NoOp(üîÄ Campaign 1 ‚Üí DIDWW)
 same => n,Goto(didww-out,${EXTEN},1)

exten => _+1XXXXXXXXXX,1,NoOp(üîÄ NANPA (+1) ‚Üí CHECK: ${EXTEN})
 same => n,GotoIf($["${CALLERID(num)}" = "13038793188"]?telnyx-local)
 same => n,GotoIf($["${CALLERID(num)}" = "+13038793188"]?telnyx-local)
 same => n,GotoIf($["${CALLERID(num)}" = "18886511410"]?telnyx-tollfree)
 same => n,GotoIf($["${CALLERID(num)}" = "+18886511410"]?telnyx-tollfree)
 same => n,GotoIf($["${CALLERID(num)}" = "18887719500"]?didww-out,${EXTEN},1)
 same => n,GotoIf($["${CALLERID(num)}" = "+18887719500"]?didww-out,${EXTEN},1)
 same => n,GotoIf($["${CALLERID(num)}" = "50642052929"]?metrocom-out,${EXTEN},1)
 same => n,GotoIf($["${CALLERID(num)}" = "+50642052929"]?metrocom-out,${EXTEN},1)
 same => n,Goto(didww-out,${EXTEN},1) ; Default fallback

 same => n(telnyx-local),Goto(telnyx-local-out,${EXTEN},1)
 same => n(telnyx-tollfree),Goto(telnyx-tollfree-out,${EXTEN},1)

exten => _+X.,1,NoOp(üîÄ Internacional ‚Üí CHECK: ${EXTEN})
 same => n,GotoIf($["${CALLERID(num)}" = "13038793188"]?telnyx-local)
 same => n,GotoIf($["${CALLERID(num)}" = "+13038793188"]?telnyx-local)
 same => n,GotoIf($["${CALLERID(num)}" = "18886511410"]?telnyx-tollfree)
 same => n,GotoIf($["${CALLERID(num)}" = "+18886511410"]?telnyx-tollfree)
 same => n,GotoIf($["${CALLERID(num)}" = "18887719500"]?didww-out,${EXTEN},1)
 same => n,GotoIf($["${CALLERID(num)}" = "+18887719500"]?didww-out,${EXTEN},1)
 same => n,GotoIf($["${CALLERID(num)}" = "50642052929"]?metrocom-out,${EXTEN},1)
 same => n,GotoIf($["${CALLERID(num)}" = "+50642052929"]?metrocom-out,${EXTEN},1)
 same => n,Goto(didww-out,${EXTEN},1) ; Default fallback

 same => n(telnyx-local),Goto(telnyx-local-out,${EXTEN},1)
 same => n(telnyx-tollfree),Goto(telnyx-tollfree-out,${EXTEN},1)


; ============================================================
;  TELNYX OUTBOUND CONTEXTS
; ============================================================
[telnyx-local-out]
exten => _X.,1,NoOp(üì° TELNYX LOCAL OUT ‚Üí ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN}@telnyx_local_out,60,T)
 same => n,Hangup()

[telnyx-tollfree-out]
exten => _X.,1,NoOp(üì° TELNYX TOLLFREE OUT ‚Üí ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN}@telnyx_tollfre_out,60,T)
 same => n,Hangup()

; üî• NUEVA LOGICA DE ENRUTAMIENTO MANUAL (Omnileads Console) üî•
; Si OMLCAMPID = 3 -> Usar TELNYX (TollFree)
; Si OMLCAMPID = 4 -> Usar TELNYX (Local)
; Esto asume que configurar√°s campa√±as con ID 3 y 4 en Omnileads si es posible,
; O simplemente forzamos Telnyx para pruebas si detectamos cierto patr√≥n.

; Alternativa: Detectar si es manual y usar Telnyx por defecto si no es CR
; Pero actualmente tu queja es que "sale por didww". Eso es porque cae en:
; exten => _+X.,1 ... Goto(didww-out)

; Vamos a cambiar el default para internacional a Telnyx si no es CR


; ============================================================
;  METROCOM OUT - Con estados y AMD
; ============================================================
[metrocom-out]
exten => _+506XXXXXXXX,1,NoOp(üì° METROCOM ‚Üí ${EXTEN})
 same => n,Set(CALLERID(num)=${IF($["${CALLERID(num)}" != ""]?${CALLERID(num)}:50642052929)})
 same => n,Set(CALLERID(name)=${IF($["${CALLERID(name)}" != ""]?${CALLERID(name)}:AIS)})
 same => n,Set(__DIAL_START=${EPOCH})
 same => n,Set(__CALL_ID=${AMD_CALL_ID})
 ;same => n,Set(DEST=${EXTEN:1})  ; +50662817277 ‚Üí 50662817277
 same => n,Dial(PJSIP/${EXTEN}@metrocom_out_aux,30,TgU(check-amd))
 same => n,NoOp(üìã DIALSTATUS=${DIALSTATUS} para ${CALL_ID})
 same => n,GotoIf($["${DIALSTATUS}" = "NOANSWER"]?no_answer)
 same => n,GotoIf($["${DIALSTATUS}" = "CANCEL"]?no_answer)
 same => n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy)
 same => n,GotoIf($["${DIALSTATUS}" = "CONGESTION"]?failed)
 same => n,GotoIf($["${DIALSTATUS}" = "CHANUNAVAIL"]?failed)
 same => n,Hangup()
 same => n(no_answer),NoOp(üìµ NO ANSWER: ${CALL_ID})
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/amd-result?call_id=${CALL_ID}&result=NO_ANSWER&cause=TIMEOUT_${DIALSTATUS})})
 same => n,Hangup()
 same => n(busy),NoOp(üìµ BUSY: ${CALL_ID})
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/amd-result?call_id=${CALL_ID}&result=BUSY&cause=LINE_BUSY)})
 same => n,Hangup()
 same => n(failed),NoOp(‚ùå FAILED: ${CALL_ID} - ${DIALSTATUS})
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/amd-result?call_id=${CALL_ID}&result=FAILED&cause=${DIALSTATUS})})
 same => n,Hangup()

exten => _506XXXXXXXX,1,NoOp(üì° METROCOM ‚Üí +${EXTEN})
 same => n,Set(CALLERID(num)=${IF($["${CALLERID(num)}" != ""]?${CALLERID(num)}:50642052929)})
 same => n,Set(CALLERID(name)=${IF($["${CALLERID(name)}" != ""]?${CALLERID(name)}:AIS)})
 same => n,Set(__DIAL_START=${EPOCH})
 same => n,Set(__CALL_ID=${AMD_CALL_ID})
 same => n,Dial(PJSIP/+${EXTEN}@metrocom_out_aux,30,TgU(check-amd))
 same => n,NoOp(üìã DIALSTATUS=${DIALSTATUS} para ${CALL_ID})
 same => n,GotoIf($["${DIALSTATUS}" = "NOANSWER"]?no_answer)
 same => n,GotoIf($["${DIALSTATUS}" = "CANCEL"]?no_answer)
 same => n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy)
 same => n,GotoIf($["${DIALSTATUS}" = "CONGESTION"]?failed)
 same => n,GotoIf($["${DIALSTATUS}" = "CHANUNAVAIL"]?failed)
 same => n,Hangup()
 same => n(no_answer),NoOp(üìµ NO ANSWER: ${CALL_ID})
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/amd-result?call_id=${CALL_ID}&result=NO_ANSWER&cause=TIMEOUT_${DIALSTATUS})})
 same => n,Hangup()
 same => n(busy),NoOp(üìµ BUSY: ${CALL_ID})
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/amd-result?call_id=${CALL_ID}&result=BUSY&cause=LINE_BUSY)})
 same => n,Hangup()
 same => n(failed),NoOp(‚ùå FAILED: ${CALL_ID} - ${DIALSTATUS})
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/amd-result?call_id=${CALL_ID}&result=FAILED&cause=${DIALSTATUS})})
 same => n,Hangup()

exten => _XXXXXXXX,1,NoOp(üì° METROCOM Local ‚Üí +506${EXTEN})
 same => n,Set(CALLERID(num)=${IF($["${CALLERID(num)}" != ""]?${CALLERID(num)}:50642052929)})
 same => n,Set(CALLERID(name)=${IF($["${CALLERID(name)}" != ""]?${CALLERID(name)}:AIS)})
 same => n,Set(__DIAL_START=${EPOCH})
 same => n,Set(__CALL_ID=${AMD_CALL_ID})
 same => n,Dial(PJSIP/+506${EXTEN}@metrocom_out_aux,30,TgU(check-amd))
 same => n,NoOp(üìã DIALSTATUS=${DIALSTATUS} para ${CALL_ID})
 same => n,GotoIf($["${DIALSTATUS}" = "NOANSWER"]?no_answer)
 same => n,GotoIf($["${DIALSTATUS}" = "CANCEL"]?no_answer)
 same => n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy)
 same => n,GotoIf($["${DIALSTATUS}" = "CONGESTION"]?failed)
 same => n,GotoIf($["${DIALSTATUS}" = "CHANUNAVAIL"]?failed)
 same => n,Hangup()
 same => n(no_answer),NoOp(üìµ NO ANSWER: ${CALL_ID})
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/amd-result?call_id=${CALL_ID}&result=NO_ANSWER&cause=TIMEOUT_${DIALSTATUS})})
 same => n,Hangup()
 same => n(busy),NoOp(üìµ BUSY: ${CALL_ID})
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/amd-result?call_id=${CALL_ID}&result=BUSY&cause=LINE_BUSY)})
 same => n,Hangup()
 same => n(failed),NoOp(‚ùå FAILED: ${CALL_ID} - ${DIALSTATUS})
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/amd-result?call_id=${CALL_ID}&result=FAILED&cause=${DIALSTATUS})})
 same => n,Hangup()


; ============================================================
;  DIDWW OUT - Con estados y AMD
; ============================================================
[didww-out]
exten => _+X.,1,NoOp(üì° DIDWW OUT ‚Üí ${EXTEN})
 same => n,Set(CALLERID(num)=${IF($["${FROM_NUMBER}" != ""]?${FROM_NUMBER}:+18887719555)})
 same => n,Set(CALLERID(name)=${IF($["${CALLERID(name)}" != ""]?${CALLERID(name)}:AIS)})
 same => n,Set(__DIAL_START=${EPOCH})
 same => n,Set(__CALL_ID=${AMD_CALL_ID})
 same => n,Dial(PJSIP/${EXTEN}@didww_out_aux,30,TgU(check-amd))
 same => n,NoOp(üìã DIALSTATUS=${DIALSTATUS} para ${CALL_ID})
 same => n,GotoIf($["${DIALSTATUS}" = "NOANSWER"]?no_answer)
 same => n,GotoIf($["${DIALSTATUS}" = "CANCEL"]?no_answer)
 same => n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy)
 same => n,GotoIf($["${DIALSTATUS}" = "CONGESTION"]?failed)
 same => n,GotoIf($["${DIALSTATUS}" = "CHANUNAVAIL"]?failed)
 same => n,Hangup()
 same => n(no_answer),NoOp(üìµ NO ANSWER: ${CALL_ID})
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/amd-result?call_id=${CALL_ID}&result=NO_ANSWER&cause=TIMEOUT_${DIALSTATUS})})
 same => n,Hangup()
 same => n(busy),NoOp(üìµ BUSY: ${CALL_ID})
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/amd-result?call_id=${CALL_ID}&result=BUSY&cause=LINE_BUSY)})
 same => n,Hangup()
 same => n(failed),NoOp(‚ùå FAILED: ${CALL_ID} - ${DIALSTATUS})
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/amd-result?call_id=${CALL_ID}&result=FAILED&cause=${DIALSTATUS})})
 same => n,Hangup()


; ============================================================
;  CHECK-AMD - Usado por DIDWW y Metrocom
; ============================================================
[check-amd]
exten => s,1,NoOp(üîç AMD Check - CallID: ${AMD_CALL_ID})
 same => n,Set(ANSWER_TIME=$[${EPOCH} - ${DIAL_START}])
 same => n,NoOp(‚è±Ô∏è Respondi√≥ en ${ANSWER_TIME}s)
 same => n,GotoIf($[${ANSWER_TIME} < 2]?failed)
 same => n,GotoIf($[${ANSWER_TIME} < 4]?amd_check:human)
 same => n(human),NoOp(‚úÖ Respondi√≥ despu√©s de 4s - probablemente humano)
 same => n,Set(AMD_RESULT=HUMAN)
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/amd-result?call_id=${AMD_CALL_ID}&result=HUMAN&cause=LATE_ANSWER)})
 same => n,Return()
 same => n(amd_check),NoOp(‚ö° Respuesta 2-4s - ejecutando AMD)
 same => n,AMD(3000,2000,1200,5000,120,50,5,256)
 same => n,NoOp(ü§ñ AMD: ${AMDSTATUS} | ${AMDCAUSE})
 same => n,GotoIf($["${AMDSTATUS}" = "MACHINE"]?voicemail)
 same => n,Set(AMD_RESULT=HUMAN)
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/amd-result?call_id=${AMD_CALL_ID}&result=HUMAN&cause=${AMDCAUSE})})
 same => n,Return()
 same => n(voicemail),NoOp(‚ùå Contestadora detectada: ${AMDCAUSE})
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/amd-result?call_id=${AMD_CALL_ID}&result=VOICEMAIL&cause=${AMDCAUSE})})
 same => n,UserEvent(AMDDetection,CallID: ${AMD_CALL_ID},Result: VOICEMAIL,Cause: ${AMDCAUSE})
 same => n,Hangup()
 same => n(failed),NoOp(‚ö†Ô∏è Respuesta < 2s - Llamada fallida/n√∫mero inv√°lido)
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/amd-result?call_id=${AMD_CALL_ID}&result=FAILED&cause=FAST_ANSWER)})
 same => n,UserEvent(AMDDetection,CallID: ${AMD_CALL_ID},Result: FAILED,Cause: FAST_ANSWER)
 same => n,Hangup()


; ============================================================
;  RETELL ORIGINATE - Decide DIDWW o Metrocom seg√∫n FROM_NUMBER
; ============================================================
[retell-originate]
exten => _+X.,1,NoOp(ü§ñ Retell Originate ‚Üí ${EXTEN} | FROM=${FROM_NUMBER})
 same => n,Set(__AMD_CALL_ID=${RETELL_CALL_ID})
 same => n,Set(CALLERID(num)=${FROM_NUMBER})
 same => n,Set(CALLERID(name)=Retell AI)
 same => n,GotoIf($["${FROM_NUMBER:0:4}" = "+506"]?metrocom:didww)
 same => n(metrocom),NoOp(üá®üá∑ Usando Metrocom para ${EXTEN})
 same => n,Goto(metrocom-out,${EXTEN},1)
 same => n(didww),NoOp(üá∫üá∏ Usando DIDWW para ${EXTEN})
 same => n,Goto(didww-out,${EXTEN},1)

exten => _X.,1,NoOp(ü§ñ Retell Originate (sin +) ‚Üí ${EXTEN} | FROM=${FROM_NUMBER})
 same => n,Set(__AMD_CALL_ID=${RETELL_CALL_ID})
 same => n,Set(NUM=+${EXTEN})
 same => n,Set(CALLERID(num)=${FROM_NUMBER})
 same => n,Set(CALLERID(name)=Retell AI)
 same => n,GotoIf($["${FROM_NUMBER:0:4}" = "+506"]?metrocom:didww)
 same => n(metrocom),NoOp(üá®üá∑ Usando Metrocom para ${NUM})
 same => n,Goto(metrocom-out,${NUM},1)
 same => n(didww),NoOp(üá∫üá∏ Usando DIDWW para ${NUM})
 same => n,Goto(didww-out,${NUM},1)


; ============================================================
;  RETELL BRIDGE - Conecta con Retell despu√©s de contestar
; ============================================================
[retell-bridge]
exten => s,1,NoOp(üéô Conectando con Retell. CALL_ID=${RETELL_CALL_ID})
 same => n,Answer()
 same => n,Wait(1)
 same => n,Set(RETELL_URI=sip:${RETELL_CALL_ID}@sip.retellai.com)
 same => n,NoOp(üì° ‚Üí ${RETELL_URI})
 same => n,Dial(PJSIP/retell_out_udp/${RETELL_URI},60,T)
 same => n,NoOp(üìã DIALSTATUS=${DIALSTATUS} HANGUPCAUSE=${HANGUPCAUSE})
 same => n,Hangup()


[retell-predial]
exten => s,1,NoOp(üîß Pre-dial para Retell)
 same => n,Set(PJSIP_HEADER(add,X-Retell-Call-Id)=${RETELL_CALL_ID})
 same => n,Return()


[bridge-transfer]
exten => s,1,NoOp(üîÄ Bridging agent to customer)
 same => n,Answer()
 same => n,Wait(0.5)
 same => n,Bridge(${TARGET_CHANNEL},T)
 same => n,Hangup()


[from-retell]
exten => _X.,1,NoOp(ü§ñ RETELL AI ‚Üí ${EXTEN})
 same => n,Set(CALLERID(num)=18887719555)
 same => n,Set(CALLERID(name)=Retell AI)
 same => n,Set(NUM=+${EXTEN})
 same => n,Goto(didww-out,${NUM},1)

exten => _+X.,1,NoOp(ü§ñ RETELL AI E.164 ‚Üí ${EXTEN})
 same => n,Set(CALLERID(num)=18887719555)
 same => n,Set(CALLERID(name)=Retell AI)
 same => n,Goto(didww-out,${EXTEN},1)

; ===========================================================
; CONTEXTO PARA TRANSFERENCIAS - AGREGAR A extensions.conf
; ===========================================================

[bridge-direct]
; Contexto usado cuando agente acepta transferencia
; El Exten en Originate es el canal de Retell

exten => _.,1,NoOp(üîÄ Transfer Bridge: Agent ‚Üí ${EXTEN})
 same => n,Set(TARGET=${EXTEN})  ; Canal de Retell
 same => n,Set(TRANSFER_ID=${TRANSFER_ID})
 same => n,Answer()

 ; Hacer bridge directo con el canal de Retell
 same => n,Bridge(${TARGET},kKtT)
 same => n,NoOp(üîå Desconectando IA despu√©s de bridge)
 same => n,SoftHangup(${TARGET},a)  ; ‚Üê Colgar canal de Retell

 ; Cuando termina el bridge
 same => n,NoOp(‚úÖ Transfer completed: ${TRANSFER_ID})

 ; Notificar a FastAPI que termin√≥
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/complete-transfer?transfer_id=${TRANSFER_ID}&success=true)})

 same => n,Hangup()
; Manejo de errores
exten => failed,1,NoOp(‚ùå Transfer failed: ${TRANSFER_ID})
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/complete-transfer?transfer_id=${TRANSFER_ID}&success=false)})
 same => n,Hangup()
 

; ============================================================
;  CLASSIFIER - Logica de clasificacion de numeros
; ============================================================

[classifier-originate]
exten => _X.,1,NoOp(üîç Classifier Originate ‚Üí ${EXTEN})
 same => n,Set(NUM=+${EXTEN})
 same => n,Goto(classifier-out,${NUM},1)

exten => _+X.,1,NoOp(üîç Classifier Originate E.164 ‚Üí ${EXTEN})
 same => n,Goto(classifier-out,${EXTEN},1)


[classifier-out]
exten => _+X.,1,NoOp(üì° CLASSIFIER ROUTING ‚Üí ${EXTEN})
 same => n,Set(__DIAL_START=${EPOCH})
 
 ; Check Routing: US/Canada (+1) vs Rest of World
 same => n,GotoIf($["${EXTEN:0:2}" = "+1"]?use_local:use_tollfree)

 same => n(use_local),NoOp(üá∫üá∏/üá®üá¶ US/CA detected -> Using Telnyx Local)
 same => n,Dial(PJSIP/${EXTEN}@telnyx_local_out,20,gU(classifier-answer-handler^${EXTEN}))
 same => n,Goto(analyze)

 same => n(use_tollfree),NoOp(üåç ROW detected -> Using Telnyx TollFree)
 same => n,Dial(PJSIP/${EXTEN}@telnyx_tollfre_out,20,gU(classifier-answer-handler^${EXTEN}))
 same => n,Goto(analyze)
 
 same => n(analyze),NoOp(üìã CLASSIFIER RESULT: Status=${DIALSTATUS} Cause=${HANGUPCAUSE})
 
 ; 1. Check ANSWER (SIP 200)
 same => n,GotoIf($["${DIALSTATUS}" = "ANSWER"]?active)
 
 ; 2. Check Active Causes (SIPQ.850)
 same => n,GotoIf($["${HANGUPCAUSE}" = "17"]?active) ; Busy (SIP 486)
 same => n,GotoIf($["${HANGUPCAUSE}" = "18"]?active) ; No Answer (SIP 408/480)
 same => n,GotoIf($["${HANGUPCAUSE}" = "19"]?active) ; No Answer
 same => n,GotoIf($["${HANGUPCAUSE}" = "16"]?active) ; Normal Clearing / Cancel (SIP 487)
 same => n,GotoIf($["${HANGUPCAUSE}" = "102"]?active) ; Recovery on timer (SIP 408)
 same => n,GotoIf($["${HANGUPCAUSE}" = "21" & "${DIALSTATUS}" = "BUSY"]?active) ; Rejected/Busy (SIP 603)
 
 ; 3. Check Inactive Causes
 same => n,GotoIf($["${HANGUPCAUSE}" = "1"]?inactive) ; Unallocated (SIP 404)
 same => n,GotoIf($["${HANGUPCAUSE}" = "22"]?inactive) ; Number Changed (SIP 410)
 same => n,GotoIf($["${HANGUPCAUSE}" = "27"]?inactive) ; Dest out of order (SIP 502)
 same => n,GotoIf($["${HANGUPCAUSE}" = "38"]?inactive) ; Net out of order (SIP 503)
 same => n,GotoIf($["${HANGUPCAUSE}" = "28"]?inactive) ; Invalid Number (SIP 484)
 
 ; 4. Indeterminate (Restriccion, error temporal, etc)
 same => n,Goto(indeterminate)

 same => n(active),NoOp(‚úÖ NUMBER IS ACTIVE)
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/classifier-result?phone=${EXTEN}&status=active&cause=${HANGUPCAUSE})})
 same => n,Hangup()

 same => n(inactive),NoOp(‚ùå NUMBER IS INACTIVE)
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/classifier-result?phone=${EXTEN}&status=inactive&cause=${HANGUPCAUSE})})
 same => n,Hangup()

 same => n(indeterminate),NoOp(‚ö†Ô∏è NUMBER STATUS INDETERMINATE)
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/classifier-result?phone=${EXTEN}&status=indeterminate&cause=${HANGUPCAUSE})})
 same => n,Hangup()


[classifier-answer-handler]
exten => s,1,NoOp(‚úÖ Call Answered - Marking Active: ${ARG1})
 same => n,Set(CURL_RESULT=${CURL(http://127.0.0.1:8500/api/retell/classifier-result?phone=${ARG1}&status=active&cause=ANSWER)})
 same => n,Return()

[classifier-done]
exten => s,1,NoOp(üîö Classifier Call Finished)
 same => n,Hangup()